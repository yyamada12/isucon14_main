import{r as n,j as t}from"./jsx-runtime-56DGgGmo.js";import{b as T,c as y,d as C}from"./api-components-dDIZztSJ.js";import{a as k}from"./api-base-url-Bd0x18OB.js";import{u as j}from"./simulator-context-fn0s3fwv.js";import{a as P,b as A,g as S}from"./storage-Coaj7Roq.js";import{t as m}from"./bundle-mjs-Dnoi3Axr.js";import{T as f}from"./text-DfCqYLRl.js";import{c as d}from"./colors-DB9lnfSt.js";import{C as g}from"./chair-PB3Jm0Ii.js";import{L as U,M as D,a as G,P as v}from"./map-WlZ9yiya.js";import{B as O}from"./button-CS9qg6Tt.js";import{s as _,M as z}from"./post-message-C3RbgkUr.js";import"./get-initial-data-vd1rP8TD.js";const w=(e,s)=>{switch(!0){case e.latitude!==s.latitude:{const a=s.latitude-e.latitude>0?1:-1;return{latitude:e.latitude+a*1,longitude:e.longitude}}case e.longitude!==s.longitude:{const a=s.longitude-e.longitude>0?1:-1;return{latitude:e.latitude,longitude:e.longitude+a*1}}default:throw Error("Error: Expected status to be 'Arraived'.")}};function B(e){const s=e.slice(5).trim();return JSON.parse(s)}const K=async()=>{var e,s,a,o;try{const r=await fetch(`${k}/chair/notification`);if(!!((s=(e=r==null?void 0:r.headers.get("Content-type"))==null?void 0:e.split(";"))!=null&&s[0].includes("text/event-stream"))){const c=(a=r.body)==null?void 0:a.getReader(),u=new TextDecoder,x=(o=await(c==null?void 0:c.read()))==null?void 0:o.value,b=u.decode(x);return{data:B(b)}}return await r.json()}catch(r){console.error(r)}},R=async()=>{var s;const e=await K();return(s=e==null?void 0:e.data)==null?void 0:s.status},p=e=>(P(e),T({body:e})),H=async(e,s)=>{if(await R()==="MATCHING")return A(s),y({body:{status:"ENROUTE"},pathParams:{rideId:e}})},I=async e=>{if(await R()==="PICKUP")return y({body:{status:"CARRYING"},pathParams:{rideId:e}})},L=e=>setTimeout(()=>{p(e)},6e4),V=(e,s)=>setTimeout(()=>{try{(async()=>(await p(e),I(s)))()}catch(a){console.error(a)}},3e4),Y=e=>setTimeout(()=>{p(e)},6e4),F=()=>{const{chair:e,data:s,setCoordinate:a,isAnotherSimulatorBeingUsed:o}=j(),{pickup_coordinate:r,destination_coordinate:i,ride_id:l,status:c}=s??{};n.useEffect(()=>{if(!(r&&i&&l))return;let u;switch(c){case"ENROUTE":u=L(r);break;case"PICKUP":u=V(r,l);break;case"CARRYING":u=Y(i);break}return()=>{clearTimeout(u)}},[o,c,i,r,l]),n.useEffect(()=>{!r||c!=="PICKUP"||a==null||a(r)},[c,r,a]),n.useEffect(()=>{!i||c!=="ARRIVED"||a==null||a(i)},[c,i,a]),n.useEffect(()=>{if(o||!(e&&s))return;const u=setTimeout(()=>{p(e.coordinate);try{switch(s.status){case"MATCHING":H(s.ride_id,e.coordinate);break;case"PICKUP":I(s.ride_id);break;case"ENROUTE":a==null||a(w(e.coordinate,s.pickup_coordinate));break;case"CARRYING":a==null||a(w(e.coordinate,s.destination_coordinate));break;case"ARRIVED":a==null||a(s.destination_coordinate)}}catch{}},1e3);return()=>{clearTimeout(u)}},[e,s,a,o])},M=({onUpdate:e,className:s,checked:a,id:o,disabled:r})=>t.jsxs("div",{className:m("relative inline-block w-14 h-7",s),children:[t.jsx("input",{checked:a,onChange:()=>e(!a),id:o,type:"checkbox",className:m("peer appearance-none w-14 h-7","bg-slate-100 rounded-full checked:bg-emerald-500","focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-900","transition-colors duration-300",!r&&"cursor-pointer"),disabled:r}),t.jsx("label",{htmlFor:o,className:m("absolute top-0 left-0 w-7 h-7 pointer-events-none","bg-white rounded-full border border-slate-300 shadow-sm","transition-transform duration-300","peer-checked:translate-x-7 peer-checked:border-emerald-500",!r&&"cursor-pointer")})]}),N=({children:e,className:s,...a})=>t.jsx("div",{className:m("bg-white rounded shadow px-6 py-4 w-full relative",s),...a,children:e}),$=()=>{const{chair:e,isAnotherSimulatorBeingUsed:s}=j(),[a,o]=n.useState(!0),r=n.useCallback(i=>{try{C({body:{is_active:i}}),o(i)}catch(l){console.error(l)}},[o]);return e?t.jsxs(N,{"aria-disabled":s,children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx(f,{size:"sm",className:"text-neutral-500",bold:!0,children:"配車を受け付ける"}),t.jsx(M,{checked:a,onUpdate:i=>r(i),id:"chair-activity"})]}),s&&t.jsx("div",{role:"presentation",className:"absolute top-0 left-0 w-full h-full bg-neutral-500 bg-opacity-60 flex items-center justify-center cursor-not-allowed"})]}):null},W=({coordinate:e,setCoordinate:s})=>{const[a,o]=n.useState(),[r,i]=n.useState(),[l,c]=n.useState(!1),u=n.useRef(null),x=n.useCallback(()=>{o(e),c(!0)},[e]),b=n.useCallback(()=>{var h;r&&(s==null||s(r)),(h=u.current)==null||h.close(),c(!1)},[r,s]);return t.jsxs(t.Fragment,{children:[t.jsx(U,{className:"w-full text-right",location:e,label:"椅子位置",placeholder:"現在位置を設定",onClick:x}),l&&t.jsx("div",{className:"fixed inset-0 z-10",children:t.jsx(D,{ref:u,center:!0,onClose:b,className:"absolute w-full max-w-[800px] max-h-none h-[700px]",children:t.jsxs("div",{className:"w-full h-full flex flex-col items-center",children:[t.jsx(G,{className:"flex-1",initialCoordinate:a,from:a,onMove:h=>i(h),selectable:!0}),t.jsx(O,{className:"w-full mt-6",onClick:b,variant:"primary",children:"この位置で確定する"})]})})})]})},X={MATCHING:["空車",d.sky[500]],ENROUTE:["迎車",d.amber[500]],PICKUP:["乗車待ち",d.amber[500]],CARRYING:["賃走",d.red[500]],ARRIVED:["到着",d.emerald[500]],COMPLETED:["空車",d.sky[500]]},J=({currentStatus:e,className:s,...a})=>{const[o,r]=X[e];return t.jsxs("div",{className:m("font-bold flex items-center space-x-1",s),...a,children:[t.jsx("div",{role:"presentation",className:"w-3 h-3 rounded-full",style:{backgroundColor:r}}),t.jsx(f,{size:"sm",style:{color:r},children:o})]})},E=(e,s,a)=>{const o=Math.abs(a.latitude-e.latitude)+Math.abs(a.longitude-e.longitude),r=Math.abs(a.latitude-s.latitude)+Math.abs(a.longitude-s.longitude);return Math.floor((o-r)/o*100)},q=({model:e,rideStatus:s,pickupLoc:a,destLoc:o,currentLoc:r})=>{const i=n.useMemo(()=>typeof s<"u"?S():null,[s]),l=n.useMemo(()=>{if(!s||!a||!i||!r)return 0;switch(s){case"MATCHING":case"COMPLETED":return 0;case"PICKUP":case"ARRIVED":case"CARRYING":return 100;default:return E(i,r,a)}},[s,a,i,r]),c=n.useMemo(()=>{if(!s||!o||!a||!r)return 0;switch(s){case"MATCHING":case"COMPLETED":case"PICKUP":case"ENROUTE":return 0;case"ARRIVED":return 100;default:return E(a,r,o)}},[s,o,a,r]);return t.jsxs("div",{className:"flex items-center border-b pb-0.5 w-full",children:[t.jsxs("div",{className:"flex w-1/2",children:[t.jsx("div",{className:"w-full me-6",children:s&&["MATCHING","COMPLETED","ENROUTE"].includes(s)&&t.jsx("div",{className:"transition-transform duration-300",style:{transform:`translateX(${l}%)`},children:t.jsx("div",{className:m(s==="ENROUTE"&&"animate-shake"),children:t.jsx(g,{model:e,className:"scale-x-[-1] size-6"})})})}),t.jsx(v,{color:d.black,width:20})]}),t.jsxs("div",{className:"flex w-1/2",children:[t.jsx("div",{className:"w-full me-6",children:s&&["PICKUP","CARRYING","ARRIVED"].includes(s)&&t.jsx("div",{className:"transition-transform duration-300",style:{transform:`translateX(${c}%)`},children:t.jsx("div",{className:m(s==="CARRYING"&&"animate-shake"),children:t.jsx(g,{model:e,className:"scale-x-[-1] size-6"})})})}),t.jsx(v,{color:d.red[500],width:20})]})]})},Q=n.memo(function({chairModel:s,chairName:a,rideStatus:o}){return s&&a&&o?t.jsxs("div",{className:"flex items-center space-x-4",children:[t.jsx(g,{model:s,className:"size-12 shrink-0"}),t.jsxs("div",{className:"space-y-0.5 w-full",children:[t.jsx(f,{bold:!0,children:a}),t.jsx(f,{className:"text-xs text-neutral-500",children:s}),t.jsx(J,{currentStatus:o})]})]}):null},(e,s)=>e.chairModel===s.chairModel&&e.chairName===s.chairName&&e.rideStatus===s.rideStatus),Z=()=>{const{data:e,chair:s,setCoordinate:a,isAnotherSimulatorBeingUsed:o}=j(),r=n.useMemo(()=>(e==null?void 0:e.status)??"MATCHING",[e]);return t.jsxs(N,{"aria-disabled":o,children:[!s&&t.jsx(f,{className:"m-4",size:"sm",children:"椅子のデータがありません"}),s&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"space-y-4",children:[t.jsx(Q,{chairModel:s.model,chairName:s.name,rideStatus:r}),t.jsx(W,{coordinate:s.coordinate,setCoordinate:a}),t.jsx(q,{model:s.model,rideStatus:r,currentLoc:s.coordinate,pickupLoc:e==null?void 0:e.pickup_coordinate,destLoc:e==null?void 0:e.destination_coordinate})]}),o&&t.jsx("div",{className:"absolute top-0 left-0 w-full h-full bg-neutral-500 bg-opacity-60 flex items-center justify-center cursor-not-allowed",children:t.jsx(f,{className:"text-white",bold:!0,size:"sm",children:"現在、他のシミュレーターが使用中です"})})]})]})},ee=({simulatorRef:e})=>{const[s,a]=n.useState(!1),[o,r]=n.useState({ghostChairEnabled:!0});return n.useEffect(()=>{var i;s&&(i=e.current)!=null&&i.contentWindow&&_(e.current.contentWindow,o)},[o,s,e]),n.useEffect(()=>{const i=({data:l})=>{var u;origin==location.origin&&l.type===z.ClientReady&&a(!!((u=l==null?void 0:l.payload)!=null&&u.ready))};return window.addEventListener("message",i),()=>{window.removeEventListener("message",i)}},[]),t.jsx(N,{children:t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx(f,{size:"sm",className:"text-neutral-500",bold:!0,children:"疑似チェアを表示する"}),t.jsx(M,{id:"ghost-chair",checked:o.ghostChairEnabled,onUpdate:i=>{r(l=>({...l,ghostChairEnabled:i}))}})]})})};function se({children:e}){return t.jsx("div",{className:m("w-[420px] h-[798px] lg:w-[480px] lg:h-[900px] bg-black p-[20px] rounded-[60px] relative","before:block before:bg-black before:absolute before:left-1/2 before:-translate-x-1/2","before:w-[200px] before:h-[30px] before:rounded-bl-3xl before:rounded-br-3xl shrink-0"),children:t.jsx("div",{className:"h-full flex flex-col overflow-hidden rounded-[40px] before:block before:h-[30px] before:bg-sky-700",children:e})})}const xe=()=>[{title:"Simulator | ISURIDE"},{name:"description",content:"isucon14"}];function be(){const e=n.useRef(null);return F(),n.useEffect(()=>{try{C({body:{is_active:!0}})}catch(s){console.error(s)}},[]),t.jsxs("main",{className:"h-screen flex justify-center items-center space-x-8 lg:space-x-16",children:[t.jsx(se,{children:t.jsx("iframe",{title:"ISURIDE Client App",src:"/client",className:"w-full h-full",ref:e})}),t.jsxs("div",{className:"space-y-4 min-w-[320px] lg:w-[400px]",children:[t.jsx("h1",{className:"text-lg font-semibold mb-4",children:"Chair Simulator"}),t.jsx(Z,{}),t.jsx($,{}),t.jsx(ee,{simulatorRef:e})]})]})}export{be as default,xe as meta};
