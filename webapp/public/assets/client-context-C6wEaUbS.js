import{r as a,j as w}from"./jsx-runtime-56DGgGmo.js";import{a as S}from"./api-base-url-Bd0x18OB.js";import{m as N}from"./api-components-dDIZztSJ.js";import{g as _}from"./get-cookie-value-B3QhECDc.js";import{h as R}from"./storage-Coaj7Roq.js";import{f as y}from"./index-9ZhTBp7q.js";function A(n){const i=n.slice(5).trim();try{return JSON.parse(i)}catch{console.error(`don't parse ${n}`)}}const I=()=>{const n=y(),[i,l]=a.useState(!1),[r,u]=a.useState(),x=(r==null?void 0:r.retry_after_ms)??1e4;return a.useEffect(()=>{(async()=>{var o,s,e;try{const t=await fetch(`${S}/app/notification`);if(t.status===401){n("/client/register");return}const c=(o=t==null?void 0:t.headers.get("Content-type"))==null?void 0:o.split(";")[0].includes("text/event-stream");if(l(!!c),c){const f=(s=t.body)==null?void 0:s.getReader(),g=new TextDecoder,C=(e=await(f==null?void 0:f.read()))==null?void 0:e.value,j=g.decode(C),E=A(j);u(E?{data:E}:void 0);return}const m=await t.json();u(m)}catch(t){console.error(t)}})()},[n]),a.useEffect(()=>{if(!i)return;const d=new EventSource(`${S}/app/notification`);d.addEventListener("message",o=>{if(typeof o.data=="string"){const s=JSON.parse(o.data);u(e=>{var t,c;return e===void 0||(s==null?void 0:s.status)!==((t=e==null?void 0:e.data)==null?void 0:t.status)||(s==null?void 0:s.ride_id)!==((c=e==null?void 0:e.data)==null?void 0:c.ride_id)?{data:s}:e})}return()=>{d.close()}})},[i,u]),a.useEffect(()=>{if(i)return;let d,o;const s=async()=>{try{o=new AbortController;const e=await N({},o.signal);u(t=>{var c,m,f,g;return(t==null?void 0:t.data)===void 0||((c=t==null?void 0:t.data)==null?void 0:c.status)!==((m=e.data)==null?void 0:m.status)||((f=t==null?void 0:t.data)==null?void 0:f.ride_id)!==((g=e.data)==null?void 0:g.ride_id)?e:t}),d=setTimeout(()=>void s(),x)}catch(e){if(e instanceof DOMException&&e.name==="AbortError")return;console.error(e)}};return d=setTimeout(()=>void s(),x),()=>{o==null||o.abort(),clearTimeout(d)}},[i,n,x]),r==null?void 0:r.data},h=a.createContext({}),p=({children:n})=>{const[i]=a.useState(()=>R()),l=y(),r=I();return a.useEffect(()=>{typeof _(document.cookie,"app_session")<"u"||l("/client/register")},[l]),w.jsx(h.Provider,{value:{data:r,userId:i},children:n})},J=()=>a.useContext(h);export{p as C,J as u};
