import{r as n,j as x}from"./jsx-runtime-56DGgGmo.js";import{b as _}from"./get-initial-data-vd1rP8TD.js";import{a as p}from"./api-base-url-Bd0x18OB.js";import{l as w}from"./api-components-dDIZztSJ.js";import{M as I}from"./post-message-C3RbgkUr.js";import{d as R,e as j,f as M}from"./storage-Coaj7Roq.js";const v=n.createContext({}),S=_();function T(o){const i=o.slice(5).trim();return JSON.parse(i)}function A(o){return o==="ARRIVED"||o==="CARRYING"||o==="ENROUTE"||o==="PICKUP"}const O=()=>{const[o,i]=n.useState(!1),[u,m]=n.useState();n.useEffect(()=>{(async()=>{var a,r,e,s;try{const t=await fetch(`${p}/chair/notification`),c=!!((r=(a=t==null?void 0:t.headers.get("Content-type"))==null?void 0:a.split(";"))!=null&&r[0].includes("text/event-stream"));if(i(c),c){const l=(e=t.body)==null?void 0:e.getReader(),y=new TextDecoder,h=(s=await(l==null?void 0:l.read()))==null?void 0:s.value,C=y.decode(h),E=T(C);m(E?{data:E}:void 0);return}const g=await t.json();m(g)}catch(t){if(t instanceof DOMException&&t.name==="AbortError")return;console.error(t)}})()},[m]);const f=(u==null?void 0:u.retry_after_ms)??1e4;return n.useEffect(()=>{if(!o)return;const d=new EventSource(`${p}/chair/notification`),a=({data:r})=>{if(typeof r=="string"){try{const e=JSON.parse(r);m(s=>{var t,c;return s===void 0||(e==null?void 0:e.status)!==((t=s.data)==null?void 0:t.status)||(e==null?void 0:e.ride_id)!==((c=s.data)==null?void 0:c.ride_id)?{data:e,contentType:"event-stream"}:s})}catch(e){console.error(e)}return()=>{d.close()}}};return d.addEventListener("message",a),()=>{d.close()}},[o]),n.useEffect(()=>{if(o)return;let d,a;const r=async()=>{try{a=new AbortController;const e=await w({},a.signal);m(s=>{var t,c,g,l;return s===void 0||((t=e==null?void 0:e.data)==null?void 0:t.status)!==((c=s.data)==null?void 0:c.status)||((g=e==null?void 0:e.data)==null?void 0:g.ride_id)!==((l=s.data)==null?void 0:l.ride_id)?{data:e.data,retry_after_ms:e.retry_after_ms,contentType:"json"}:s}),d=setTimeout(()=>void r(),f)}catch(e){if(e instanceof DOMException&&e.name==="AbortError")return;console.error(e)}};return d=setTimeout(()=>void r(),f),()=>{a==null||a.abort(),clearTimeout(d)}},[o,f]),u==null?void 0:u.data},F=({children:o})=>{n.useEffect(()=>{S!=null&&S.token&&(document.cookie=`chair_session=${S.token}; path=/`)},[]);const i=O(),[u,m]=n.useState(()=>R()??{latitude:0,longitude:0}),[f,d]=n.useState();n.useEffect(()=>{d(r=>r??j()??void 0)},[]);const a=n.useMemo(()=>A(i==null?void 0:i.status)&&f!==(i==null?void 0:i.ride_id),[f,i]);return n.useEffect(()=>{const r=({data:e})=>{var t;if(origin==location.origin&&e.type===I.ClientRideRequested){const c=(t=e==null?void 0:e.payload)==null?void 0:t.rideId;c&&(d(c),M(c))}};return window.addEventListener("message",r),()=>{window.removeEventListener("message",r)}},[]),x.jsx(v.Provider,{value:{data:i,chair:S?{...S,coordinate:u}:void 0,setCoordinate:m,isAnotherSimulatorBeingUsed:a},children:o})},$=()=>n.useContext(v);export{F as S,$ as u};
